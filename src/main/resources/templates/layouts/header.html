<html lang="ko-KR" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<header th:fragment="header" class="header" style="position: relative;">
	<div class="container">
		<div class="toggle-buttons">
			<!-- í´ëŸ½ ë²„íŠ¼ -->
			<button class="toggle-button life" th:classappend="${currentURI.startsWith('/facility/') ? 'selected' : ''}"
				onclick="location.href='/facility/main'">ì‹œì„¤ì˜ˆì•½</button>
			<button class="toggle-button life"
				th:classappend="${currentURI == '/' || currentURI.startsWith('/member/') || currentURI.startsWith('/club/') || currentURI.startsWith('/clubByaddress') ? 'selected' : ''}"
				onclick="location.href='/'">í´ëŸ½</button>
		</div>
		<!-- <div class="search-container">
      <input type="text" class="search-input" placeholder="ë°˜ì§ì´ëŠ” ë„ì‹œë¥¼ í’ˆì€, ì•¼ê²½ì´ ì˜ˆìœ ê³µê°„">
      <button class="search-button"><img loading="lazy" src="https://img.shareit.kr/front-assets/icons/magnifier_lineBold_gray064.svg?version=1.0"></button>
  </div> -->
		<!-- <div class="right-icons">
      <a href="#" class="icon-link">ì§€ë„</a>
      <a href="#" class="icon-link">ë§ˆì´í˜ì´ì§€</a>
  </div> -->
		<div class="logo-menu">
			<!--   <button class="menu-button">â‰¡</button> -->
			<span class="logo" onclick="location.href='/'"
				style="cursor: pointer; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">FITLINK</span>
		</div>


		<div class="flex-wrap" style="display: flex; gap: 40px; align-items: center;position:relative;">
			<div>
				<!-- <h4>í˜„ì¬ ë‚ ì”¨</h4> -->
				<div id="current-weather"></div>
				<div id="current-date" style="display: none;"></div>
				<!-- <h4>ì´ë²ˆ ì£¼ ë‚ ì”¨</h4> -->
				<div class="weather" id="weather-container" style="position:absolute; z-index: 9999; left: 50%;
    transform: translate(-50%, 0);"></div>
			</div>
			<script>
				// ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸° 
				document.addEventListener('DOMContentLoaded', function () {
					const weatherContainer = document.getElementById('weather-container');
					const currentWeather = document.getElementById('current-weather');
					const currentDateEl = document.getElementById('current-date');

					// âœ… ì‚¬ìš©ìì˜ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
					function getUserLocation() {
						if (navigator.geolocation) {
							navigator.geolocation.getCurrentPosition(
								(position) => {
									const lat = position.coords.latitude;
									const lon = position.coords.longitude;
									fetchWeather(lat, lon);
								},
								(error) => {
									console.error('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
									fetchWeatherByIP(); // ìœ„ì¹˜ ê¶Œí•œì„ ê±°ë¶€í–ˆì„ ê²½ìš° IP ê¸°ë°˜ ìœ„ì¹˜ ì¡°íšŒ
								}
							);
						} else {
							console.error('Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
							fetchWeatherByIP(); // Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš° IP ê¸°ë°˜ ì¡°íšŒ
						}
					}

					// âœ… OpenWeather APIì—ì„œ ë‚ ì”¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
					function fetchWeather(lat, lon, region = "") {
						fetch(`/api/weather?lat=${lat}&lon=${lon}`)
							.then(response => response.json())
							.then(data => displayWeather(data))
							.catch(error => console.error('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', error));
					}

					// âœ… IP ê¸°ë°˜ ìœ„ì¹˜ ì¡°íšŒ (ìœ„ì¹˜ ê¶Œí•œì´ ì—†ì„ ë•Œ ëŒ€ì²´) - í•œêµ­ì–´ ì§€ì—­ëª… ê°€ì ¸ì˜¤ê¸°
					function fetchWeatherByIP() {
						fetch('https://ipapi.co/json/')
							.then(response => response.json())
							.then(data => {
								console.log("IP ê¸°ë°˜ ìœ„ì¹˜ ë°ì´í„°:", data);

								const lat = data.latitude;
								const lon = data.longitude;

								// ì§€ì—­ëª…ì„ í•œêµ­ì–´ë¡œ ê°€ì ¸ì˜¤ê¸°
								fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ko`)
									.then(response => response.json())
									.then(locationData => {
										const region = locationData.address.state || locationData.address.city || locationData.address.town;
										console.log("í•œêµ­ì–´ ì§€ì—­ëª…:", region);

										fetchWeather(lat, lon, region);
									})
									.catch(error => {
										console.error("ì§€ì—­ëª…ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
										fetchWeather(lat, lon, "ì•Œ ìˆ˜ ì—†ìŒ");
									});
							})
							.catch(error => {
								console.error('IP ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', error);
								fetchWeather(37.5665, 126.9780, "ì„œìš¸"); // ê¸°ë³¸ê°’: ì„œìš¸
							});
					}

					// âœ… OpenWeather API ë°ì´í„°ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
					function displayWeather(data) {
						// 5ì¼ ë‚ ì”¨ ë³´ì—¬ì¤„ë•Œ ë‚®/ë°¤ ì‹œê°„ëŒ€ì— ë”°ë¼ ì•„ì´ì½˜ ë³€ê²½
						function getDayOrNightIcon(iconCode, forecastDateUTC) {
						    // OpenWeather APIì˜ forecastDateëŠ” UTC ê¸°ì¤€ â†’ ë¡œì»¬ ì‹œê°„(KST ë“±)ìœ¼ë¡œ ë³€í™˜ í•„ìš”
							const forecastDateObj = new Date(forecastDateUTC); // ë¬¸ìì—´ â†’ Date ê°ì²´ ë³€í™˜
							const localHour = forecastDateObj.getHours(); // ë³€í™˜ëœ ê°ì²´ì—ì„œ ì‹œê°„ ì¶”ì¶œ

						    console.log(`ğŸŒ ì˜ˆì¸¡ ì‹œê°„(ë¡œì»¬ ê¸°ì¤€): ${localHour}ì‹œ`); // ë””ë²„ê¹…ìš©

						    // ì˜¤í›„ 6ì‹œ(18) ~ ë‹¤ìŒë‚  ì˜¤ì „ 6ì‹œ(6) ì‚¬ì´ëŠ” 'n'(night), ë‚˜ë¨¸ì§€ëŠ” 'd'(day)
						    const isNight = localHour >= 18 || localHour < 6;

						    return isNight ? iconCode.slice(0, -1) + 'n' : iconCode.slice(0, -1) + 'd';
						}

						// ë‚ ì§œë³„ë¡œ ë‚ ì”¨ ì •ë³´ë¥¼ ì§‘ê³„
						const weatherMap = {};

						// í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
						const now = new Date().getTime() / 1000; // ì´ˆ ë‹¨ìœ„ ë³€í™˜

						// ê°€ì¥ ê°€ê¹Œìš´ ì‹œê°„ëŒ€ì˜ ë‚ ì”¨ ë°ì´í„° ì°¾ê¸°
						let closestItem = data.list.reduce((prev, curr) =>
							Math.abs(curr.dt - now) < Math.abs(prev.dt - now) ? curr : prev
						);

						data.list.forEach(item => {
							const date = new Date(item.dt * 1000);
							const options = {weekday: 'short', month: 'short', day: 'numeric'};
							const formattedDate = date.toLocaleDateString('ko-KR', options);

							if (!weatherMap[formattedDate]) {
								weatherMap[formattedDate] = {
									tempSum: 0,
									tempMin: item.main.temp_min,
									tempMax: item.main.temp_max,
									count: 0,
									weatherDescription: item.weather[0].description,
									iconCode: item.weather[0].icon,
									noonWeather: null  // âœ… ì •ì˜¤ ë‚ ì”¨ ì €ì¥ìš©
								};
							} else {
								// âœ… ìµœì €, ìµœê³  ì˜¨ë„ ê°±ì‹ 
								weatherMap[formattedDate].tempMin = Math.min(weatherMap[formattedDate].tempMin, item.main.temp_min);
								weatherMap[formattedDate].tempMax = Math.max(weatherMap[formattedDate].tempMax, item.main.temp_max);
							}

							// âœ… ì •ì˜¤(12:00) ë°ì´í„°ê°€ ìˆìœ¼ë©´ weather ì—…ë°ì´íŠ¸
							if (item.dt_txt.includes("12:00:00")) {
								weatherMap[formattedDate].noonWeather = {
									icon: item.weather[0].icon,
									description: item.weather[0].description
								};
							}

							// âœ… í‰ê·  ì˜¨ë„ ê³„ì‚°ì„ ìœ„í•œ í•©ê³„
							weatherMap[formattedDate].tempSum += item.main.temp;
							weatherMap[formattedDate].count += 1;
						});

						// âœ… í‰ê· , ìµœì €, ìµœê³  ì˜¨ë„ ê³„ì‚° ë° ì¶œë ¥
						const weatherItems = Object.keys(weatherMap).map(date => {
							const weatherInfo = weatherMap[date];
							const averageTemp = (weatherInfo.tempSum / weatherInfo.count).toFixed(1);
							const tempMin = weatherInfo.tempMin.toFixed(1);
							const tempMax = weatherInfo.tempMax.toFixed(1);

							// âœ… ì •ì˜¤(12:00) ë°ì´í„°ê°€ ìˆìœ¼ë©´ weather ì—…ë°ì´íŠ¸
							if (weatherInfo.noonWeather) {
								weatherInfo.iconCode = weatherInfo.noonWeather.icon;
								weatherInfo.weatherDescription = weatherInfo.noonWeather.description;
							}

							// âœ… ë¡œì»¬ ì´ë¯¸ì§€ ê²½ë¡œ (img í´ë” ë‚´)
							const iconUrl = `/img/${weatherInfo.iconCode}.png`;
							function getFormattedISODate(dateObj) {
							    const year = dateObj.getFullYear();
							    const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // 1ì›”=0ì´ë¯€ë¡œ +1
							    const day = String(dateObj.getDate()).padStart(2, '0');
							    const hours = String(dateObj.getHours()).padStart(2, '0');
							    const minutes = String(dateObj.getMinutes()).padStart(2, '0');
							    const seconds = String(dateObj.getSeconds()).padStart(2, '0');

							    return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
							}

							// âœ… í˜„ì¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜ (ë¡œì»¬ ì‹œê°„)
							const now = new Date();
							console.log(getFormattedISODate(now)); 

							return `
            <div class="weather-item" style="display: flex; align-items: center; min-width:300px; gap: 10px; margin-top:10px;">
				<img src="/img/${getDayOrNightIcon(weatherInfo.iconCode,getFormattedISODate(now))}.png" 
				            alt="ë‚ ì”¨ ì•„ì´ì½˜" class="weather-icon" width="40px"/>
                <div class="temp" style="display: flex; align-items: center; gap: 10px; font-size:18px;">
                    <span>${tempMin}Â°C</span> <span style="font-size:14px;color:#999;">${tempMax}Â°C</span>
                </div>
                <div class="day" style="color: #999; margin-left: auto;">${date}</div>
            </div>
        `;
						}).join('');

						weatherContainer.innerHTML = weatherItems;



						const today = new Date();
						const options = {year: 'numeric', month: 'long', day: 'numeric'};
						const formattedDate = today.toLocaleDateString('ko-KR', options);

						// âœ… í˜„ì¬ ì‹œê°„ê³¼ ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì”¨ ë°ì´í„° í‘œì‹œ
						const cityName = data.city.name;
						currentWeather.innerHTML = `
        <img src="/img/${closestItem.weather[0].icon}.png" width="40px" alt="ë‚ ì”¨ ì•„ì´ì½˜" class="weather-icon"/>
        <div class="current-temp" style="font-size: 15px; color:#fff;margin: 0 12px 0 4px;">${closestItem.main.temp}Â°C</div>
        <div class="now_weather_wrap">
            <div class="current-location">${cityName}</div>
            <div class="current-description">${closestItem.weather[0].description}</div>
        </div>
    `;

						currentDateEl.innerHTML = `<div>${formattedDate}</div>`;
					}

					getUserLocation(); // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°

				});
				$(document).ready(function () {
					$("#weather-container").hide(); // ì²˜ìŒì—ëŠ” ìˆ¨ê¹€

					// âœ… í˜„ì¬ ë‚ ì”¨ í´ë¦­ ì‹œ í† ê¸€
					$("#current-weather").click(function (event) {
						$("#weather-container").toggle();
						event.stopPropagation(); // í´ë¦­ ì´ë²¤íŠ¸ê°€ bodyê¹Œì§€ ì „íŒŒë˜ì§€ ì•Šë„ë¡ ë°©ì§€
					});

					// âœ… ì™¸ë¶€ í´ë¦­ ì‹œ ìˆ¨ê¹€
					$(document).mouseup(function (e) {
						const container = $("#weather-container");

						// âœ… í´ë¦­í•œ ìš”ì†Œê°€ #weather-container ì•ˆì— ìˆëŠ”ì§€ í™•ì¸
						if (!container.is(e.target) && container.has(e.target).length === 0) {
							container.hide(); // #weather-container ë°”ê¹¥ì„ í´ë¦­í•˜ë©´ ìˆ¨ê¹€
						}
					});
				});

			</script>

			<ul>
				<li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#none"
						role="button" aria-haspopup="true" aria-expanded="false">ë§ˆì´í˜ì´ì§€</a>
					<div class="dropdown-menu">
						<a class="dropdown-item" href="/member/mypage">ë‚˜ì˜ì •ë³´</a> <a class="dropdown-item"
							href="/member/reservation">ë‚˜ì˜ì‹œì„¤ì˜ˆì•½</a><a class="dropdown-item"
							href="/member/member_planner">ìš´ë™ìº˜ë¦°ë”</a> <a class="dropdown-item"
							href="/member/club_myclub">ë‚˜ì˜í´ëŸ½ê´€ë¦¬</a> <a class="dropdown-item"
							href="/member/club_joinclub">ê°€ì…í•œí´ëŸ½</a>
						<div class="dropdown-divider"></div>
						<!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë³€ê²½ -->
						<a class="dropdown-item" th:if="${#authentication.principal != 'anonymousUser'}"
							href="/member/logout">ë¡œê·¸ì•„ì›ƒ</a> <a class="dropdown-item"
							th:if="${#authentication.principal == 'anonymousUser'}" href="/member/login">ë¡œê·¸ì¸</a>
					</div>
				</li>
			</ul>
		</div>
		<!-- ë‚ ì”¨ -->

	</div>
</header>

</html>